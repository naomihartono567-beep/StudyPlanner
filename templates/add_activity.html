{% extends "base.html" %}
{% block content %}
<h2>Add Activity</h2>
<form id="add-activity-form" method="post">
  <label>Activity name <input name="activity_name" required></label><br>

  <label style="display:block; margin-top:14px; margin-bottom:4px;">Recurrence Pattern:</label>
  <label style="display: block; margin-left: 20px;">
    <input type="radio" name="recurrence_pattern" value="once" checked onchange="toggleForm()"> One-time activity
  </label>
  <label style="display: block; margin-left: 20px;">
  <input type="radio" name="recurrence_pattern" value="weekly" onchange="toggleForm()"> Weekly (every week)
  </label>
  <label style="display: block; margin-left: 20px;">
    <input type="radio" name="recurrence_pattern" value="biweekly" onchange="toggleForm()"> Biweekly (every other week)
  </label>

  <!-- One-time date picker (shown for 'once') -->
  <div id="one_time_block" style="margin-top:8px;">
    <label style="display:block;">Date:</label>
    <input type="date" name="one_time_date" id="one_time_date">
  </div>

  <!-- Recurrence period and weekday selection (shown for weekly/biweekly) -->
  <div id="recurrence_block" style="display:none; margin-top:12px; padding:10px; background:#f8f9fa; border-radius:6px; border-left:4px solid var(--accent);">
    <p style="margin:0 0 8px 0;"><strong>Recurrence Period</strong></p>
    <label>Start creating from: <input name="recurrence_start_date" type="date" id="recurrence_start"></label><br>
    <label>Stop creating after: <input name="recurrence_end_date" type="date" id="recurrence_end"></label><br>

  <p style="margin:8px 0 4px 0;"><strong>Days</strong> (choose which days the activity occurs)</p>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <label><input type="checkbox" name="days" value="0"> Mon</label>
      <label><input type="checkbox" name="days" value="1"> Tue</label>
      <label><input type="checkbox" name="days" value="2"> Wed</label>
      <label><input type="checkbox" name="days" value="3"> Thu</label>
      <label><input type="checkbox" name="days" value="4"> Fri</label>
      <label><input type="checkbox" name="days" value="5"> Sat</label>
      <label><input type="checkbox" name="days" value="6"> Sun</label>
    </div>
  </div>

  <!-- Time inputs used by both modes -->
  <div style="margin-top:12px;">
    <label style="display:block;">Start time:</label>
    <input type="time" name="start_time_only" id="start_time_only" required>

    <label style="display:block;">End time:</label>
    <input type="time" name="end_time_only" id="end_time_only" required>
  </div>

  <label style="display:block; margin-top:18px;">Notes (optional)</label>
  <textarea name="notes" rows="3" style="width:100%; padding:8px; border-radius:6px; border:1px solid var(--border);"></textarea>

  <!-- Hidden inputs kept for backward-compatible server parsing if needed -->
  <input type="hidden" name="start_time" id="hidden_start_time">
  <input type="hidden" name="end_time" id="hidden_end_time">

  <div style="margin-top:14px; display:flex; gap:12px;">
    <button type="submit" class="btn btn-primary">Add Activity</button>
    <button type="button" onclick="history.back();" class="link-cancel">Cancel</button>
  </div>
</form>

<script>
function toggleForm(){
  const pattern = document.querySelector('input[name="recurrence_pattern"]:checked').value;
  const rec = document.getElementById('recurrence_block');
  const one = document.getElementById('one_time_block');
  if(pattern === 'weekly' || pattern === 'biweekly'){
    rec.style.display = 'block';
    one.style.display = 'none';
  // Default recurrence dates
    const rs = document.getElementById('recurrence_start');
    const re = document.getElementById('recurrence_end');
    if(rs && !rs.value) rs.value = new Date().toISOString().split('T')[0];
    if(re && !re.value){ let d=new Date(); d.setMonth(d.getMonth()+3); re.value=d.toISOString().split('T')[0]; }
  } else {
    rec.style.display = 'none';
    one.style.display = 'block';
  }
}

document.getElementById('add-activity-form').addEventListener('submit', function(e){
  // Build ISO date-time values for server-side saving
  const pattern = document.querySelector('input[name="recurrence_pattern"]:checked').value;
  const startTime = document.getElementById('start_time_only').value;
  const endTime = document.getElementById('end_time_only').value;
  if(!startTime || !endTime){
    alert('Please provide start and end times');
    e.preventDefault();
    return;
  }

  if(pattern === 'once'){
    const oneDate = document.getElementById('one_time_date').value;
    if(!oneDate){ alert('Please select a date for the one-time activity'); e.preventDefault(); return; }
    document.getElementById('hidden_start_time').value = oneDate + 'T' + startTime;
    document.getElementById('hidden_end_time').value = oneDate + 'T' + endTime;
    return; // allow submit
  }

  // For recurring activities, seed the first occurrence date
  const rs = document.getElementById('recurrence_start').value;
  const selected = Array.from(document.querySelectorAll('input[name="days"]:checked')).map(n=>parseInt(n.value));
  if(!rs || !document.getElementById('recurrence_end').value){ alert('Please provide recurrence start/end dates'); e.preventDefault(); return; }
  const startDate = new Date(rs + 'T00:00:00');
  let seedDate = null;
  if(selected.length === 0){
    // default to recurrence_start weekday
    seedDate = startDate;
  } else {
    // Find first date on/after startDate that matches selected days
    let d = new Date(startDate);
    for(let i=0;i<14;i++){ // search up to two weeks
      // Convert JS getDay (0=Sun..6=Sat) to our 0=Mon..6=Sun
      const jsDay = d.getDay();
      const ourDay = jsDay === 0 ? 6 : jsDay - 1;
      if(selected.includes(ourDay)){
        seedDate = new Date(d);
        break;
      }
      d.setDate(d.getDate()+1);
    }
    if(!seedDate) seedDate = startDate;
  }
  // build ISO datetime strings
  const pad = (n)=> n.toString().padStart(2,'0');
  const isoDate = seedDate.getFullYear() + '-' + pad(seedDate.getMonth()+1) + '-' + pad(seedDate.getDate());
  document.getElementById('hidden_start_time').value = isoDate + 'T' + startTime;
  document.getElementById('hidden_end_time').value = isoDate + 'T' + endTime;
  // allow submit; server will expand occurrences between recurrence_start and recurrence_end
});

// initialize
toggleForm();
</script>

{% endblock %}